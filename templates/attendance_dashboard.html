<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netrica</title>
  
  <!-- Favicon -->
  <link rel="shortcut icon" href="../static/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="../static/img/favicon.ico" type="image/x-icon">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Local CSS -->
  <link rel="stylesheet" href="../static/css/style.css">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Inline Styles -->
  <style>
    html, body, .container-fluid, .row { overflow-x: hidden; }
    .table-responsive {
      max-height: 450px;
      overflow-y: auto;
      overflow-x: auto;
      margin-bottom: 20px;
      width: 100%;
      display: block;
    }
    .table {
      width: 100%;
      table-layout: fixed;
    }
    .table th, .table td {
      word-wrap: break-word;
      white-space: normal;
    }
    .main-content {
      position: relative;
      min-height: 100vh;
      padding-bottom: 130px;
    }
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #d2dbe5 !important;
      min-height: 30px;
      padding: 5px 0;
      margin: 0;
      z-index: 1000;
      text-align: center;
    }
    .footer p { font-size: 0.75rem; margin: 0; }
    .content-wrapper { margin-top: 30px; }
    .card-body { padding-bottom: 20px; }
    .pagination-container {
      position: sticky;
      bottom: 60px;
      background: #fff;
      padding: 10px;
      z-index: 999;
      border-top: 1px solid #dee2e6;
      width: 100%;
      box-sizing: border-box;
    }
    .pagination {
      justify-content: center;
      margin: 0;
      flex-wrap: wrap;
      gap: 5px;
    }
    .pagination .page-item {
      margin: 0 2px;
      flex: 0 0 auto;
    }
    .pagination .page-link {
      border: none;
      background: none;
      color: #007bff;
      padding: 5px 10px;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .pagination .page-item.active .page-link {
      background-color: #007bff;
      color: white;
      border-radius: 3px;
    }
    .pagination .page-item.disabled .page-link {
      color: #6c757d;
      pointer-events: none;
    }
    .modal-content {
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: center;
    }
    .modal-footer {
      border-top: none;
      padding-top: 0;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      padding: 5px 20px;
      border-radius: 5px;
    }
    .custom-pagination-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #f8f9fa;
      border-top: 1px solid #dee2e6;
      font-size: 0.875rem;
      color: #6c757d;
      flex-wrap: wrap;
      gap: 10px;
    }
    .custom-pagination-info select {
      padding: 2px 5px;
      font-size: 0.875rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    /* All filter columns same width */
    .col-md-2 {
      flex: 0 0 auto;
      width: 16.66666667%;
      padding-left: 20px;
      padding-right: 15px;
    }

    .logout-red { color: red; }

    /* Button container inside col-md-2 */
    .filter-action-buttons {
      display: flex;
      gap: 6px;
      width: 100%;
    }

    .filter-action-buttons .btn {
      flex: 1;
      font-size: 0.85rem;
      padding: 6px 8px;
    }

    @media (max-width: 768px) {
      .pagination-container { bottom: 70px; }
      .table th, .table td { font-size: 0.8rem; padding: 4px; }
      .main-content { padding-bottom: 180px; }
      .footer { min-height: 50px; }
      .col-md-2 { width: 50%; padding-left: 10px; padding-right: 10px; }
      .filter-action-buttons { flex-direction: column; }
      .filter-action-buttons .btn { width: 100%; }
    }
    @media (max-width: 576px) {
      .pagination-container { bottom: 80px; }
      .table th, .table td { font-size: 0.75rem; padding: 3px; }
      .main-content { padding-bottom: 200px; }
      .footer { min-height: 60px; }
      .col-md-2 { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 p-0 position-fixed top-0 start-0 vh-100">
        <div class="left-panel p-3 text-white">
          <img src="../static/img/logo.png" alt="logo" width="100" height="100" class="mx-auto d-block mb-4">
          <div id="menus">
            <div class="menu-item"><i class="bi bi-speedometer2 me-2"></i> Live Dashboard</div>
            <div class="menu-item"><i class="bi bi-people me-2"></i> Employee Logs</div>
            <div class="menu-item"><i class="bi bi-clock me-2"></i> Attendance Logs</div>
            <div class="menu-item active"><i class="bi bi-table me-2"></i> Attendance Dashboard</div>
            <div class="menu-item"><i class="bi bi-people-fill me-2"></i> Crowd Detection</div>
            <div class="menu-item"><i class="bi bi-credit-card me-2"></i> ID Card Compliance</div>
            <div class="menu-item"><i class="bi bi-display me-2"></i> Unattended System</div>
            <div class="menu-item"><i class="bi bi-moon-stars-fill me-2"></i> Sleep/Mealtime Detection</div>
            <div class="menu-item"><i class="bi bi-geo-alt me-2"></i> GEO-Fence Intrusions</div>
            <div class="menu-item"><i class="bi bi-exclamation-triangle me-2"></i> Alerts & Violations</div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-10 offset-lg-2 main-content">
        <div id="topbar-placeholder"></div>

        <div class="content-wrapper">
          <div class="card shadow-sm mx-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="bi bi-table me-2"></i> Attendance Dashboard</h6>
              <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-primary" id="todayFilter">Today</button>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-download"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" id="downloadCsv"><i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV</a></li>
                  <li><a class="dropdown-item" href="#" id="downloadExcel"><i class="bi bi-file-earmark-excel me-2"></i>Excel</a></li>
                </ul>
              </div>
            </div>

            <div class="card-body">
              <!-- Filters – All in one row, buttons same size -->
              <form class="row g-3 align-items-end mb-4" id="filterForm">
                <div class="col-md-2">
                  <label for="filterId" class="form-label small fw-bold">Employee ID</label>
                  <input type="text" id="filterId" class="form-control form-control-sm" placeholder="Enter ID">
                </div>
                <div class="col-md-2">
                  <label for="filterDepartment" class="form-label small fw-bold">Department</label>
                  <select id="filterDepartment" class="form-select form-select-sm">
                    <option value="">All</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="filterLocation" class="form-label small fw-bold">Location</label>
                  <select id="filterLocation" class="form-select form-select-sm">
                    <option value="">All</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="startDate" class="form-label small fw-bold">From</label>
                  <input type="date" id="startDate" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                  <label for="endDate" class="form-label small fw-bold">To</label>
                  <input type="date" id="endDate" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                  <label class="form-label small fw-bold invisible">Actions</label>
                  <div class="filter-action-buttons">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-funnel"></i> Apply</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="clearFilters"><i class="bi bi-x-circle"></i> Clear</button>
                  </div>
                </div>
              </form>

              <!-- Table -->
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover mb-0" id="attendanceTable">
                    <thead class="table-light">
                      <tr>
                        <th>Name</th>
                        <th>Employee ID</th>
                        <th>Department</th>
                        <th>Location</th>
                        <th>First Login</th>
                        <th>Last Logout</th>
                        <th>Total In time</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="custom-pagination-info" style="display: none;">
                  <span id="paginationInfo">Showing 1 - 10 of 0</span>
                  <div>
                    <span>Rows per page:</span>
                    <select id="rowsPerPage">
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="30">30</option>
                    </select>
                  </div>
                </div>
                <div class="pagination-container" style="display: none;">
                  <nav aria-label="Page navigation example" id="pagination">
                    <ul class="pagination">
                      <li class="page-item">
                        <a class="page-link" href="#" aria-label="Previous" id="prevPage">
                          <span aria-hidden="true">Previous</span>
                        </a>
                      </li>
                      <li class="page-item active"><a class="page-link" href="#" data-page="1">1</a></li>
                      <li class="page-item">
                        <a class="page-link" href="#" aria-label="Next" id="nextPage">
                          <span aria-hidden="true">Next</span>
                        </a>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Modal -->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-body">
                <h5 id="errorTitle" class="mb-1"></h5>
                <p id="errorMessage" class="mb-0"></p>
              </div>
              <div class="modal-footer justify-content-center border-0 pt-0">
                <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">OK</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer text-center">
          <hr class="border border-gray m-0">
          <p class="text-muted small">TatvaOne.AI © 2025. All rights reserved</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../static/js/loadLayouts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Load topbar content
    async function loadTopbar() {
      try {
        const response = await fetch('/templates/topbar.html');
        if (!response.ok) throw new Error('Failed to load topbar.html');
        const topbarContent = await response.text();
        document.getElementById('topbar-placeholder').innerHTML = topbarContent;
      } catch (err) {
        console.error('Error loading topbar:', err);
        document.getElementById('topbar-placeholder').innerHTML = '<div class="text-danger mx-3">Error loading topbar</div>';
      }
    }

    // >>> CHANGED: robust parsing + HH:MM:SS formatter + new calculation
    function parseLocalDateTime(s) {
      if (!s) return null;
      // Normalize "YYYY-MM-DD HH:MM:SS" -> "YYYY-MM-DDTHH:MM:SS"
      const isoLike = s.replace(' ', 'T');
      const d = new Date(isoLike);
      return isNaN(d) ? null : d;
    }

    function msToHHMMSS(ms) {
      if (ms <= 0) return '00:00:00';
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      const pad = n => String(n).padStart(2, '0');
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // >>> CHANGED: Now uses First Entry + Last Exit and returns HH:MM:SS
    function calculateTotalIntime(firstEntry, lastExit) {
      const start = parseLocalDateTime(firstEntry);
      const end   = parseLocalDateTime(lastExit);
      if (!start || !end || end <= start) return '00:00:00';
      return msToHHMMSS(end - start);
    }

    let allData = [];
    let filteredData = [];
    let rowsPerPage = 10;
    let currentPage = 1;
    let currentBlockIndex = 0;

    function populateDropdown(elementId, values) {
      const select = document.getElementById(elementId);
      select.innerHTML = `<option value="">All</option>`;
      values.forEach(val => {
        if (val) {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        }
      });
    }

    function renderTable(data) {
      const tbody = document.querySelector("#attendanceTable tbody");
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedData = data.slice(start, end);
      
      tbody.innerHTML = paginatedData.length
        ? paginatedData.map(item => `
          <tr>
            <td>${item.Name || 'N/A'}</td>
            <td>${item.EmployeeID || 'N/A'}</td>
            <td>${item.Department || 'N/A'}</td>
            <td>${item.Location || 'N/A'}</td>
            <td>${item.FirstLogin || 'N/A'}</td>
            <td class="logout-red">${item.LastLogout || 'N/A'}</td>
            <td>${item.TotalIntime || '00:00:00'}</td>
          </tr>
        `).join("")
        : `<tr><td colspan="7" class="text-center">No records found</td></tr>`;

      const totalItems = data.length;
      const startItem = totalItems ? start + 1 : 0;
      const endItem = Math.min(end, totalItems);
      document.getElementById('paginationInfo').textContent = `Showing ${startItem} - ${endItem} of ${totalItems}`;
      document.querySelector(".custom-pagination-info").style.display = "flex";
      updatePagination(totalItems);
    }

    function updatePagination(totalRows) {
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      const pagination = document.getElementById("pagination");
      const paginationUl = pagination.querySelector("ul.pagination");
      
      if (totalRows > rowsPerPage) {
        pagination.style.display = "block";
        
        paginationUl.innerHTML = `
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Previous" id="prevPage">
              <span aria-hidden="true">Previous</span>
            </a>
          </li>
        `;
        
        const blockSize = 5;
        const lastBlockStart = Math.max(1, totalPages - blockSize + 1);
        let pages = [];
        
        if (totalPages <= blockSize) {
          for (let i = 1; i <= totalPages; i++) pages.push(i);
        } else {
          const startPage = currentBlockIndex * blockSize + 1;
          const endPage = Math.min(startPage + blockSize - 1, totalPages);
          
          if (startPage > 1) pages.push('...');
          for (let i = startPage; i <= endPage; i++) pages.push(i);
          if (endPage < lastBlockStart - 1) pages.push('...');
          if (endPage < lastBlockStart) {
            for (let i = lastBlockStart; i <= totalPages; i++) pages.push(i);
          }
        }
        
        pages.forEach(page => {
          if (page === '...') {
            const pageItem = document.createElement("li");
            pageItem.className = "page-item disabled";
            pageItem.innerHTML = `<span class="page-link">...</span>`;
            paginationUl.appendChild(pageItem);
          } else {
            const pageItem = document.createElement("li");
            pageItem.className = `page-item${page === currentPage ? " active" : ""}`;
            pageItem.innerHTML = `<a class="page-link" href="#" data-page="${page}">${page}</a>`;
            paginationUl.appendChild(pageItem);
          }
        });
        
        paginationUl.innerHTML += `
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Next" id="nextPage">
              <span aria-hidden="true">Next</span>
            </a>
          </li>
        `;
        
        const prevButton = document.getElementById("prevPage");
        const nextButton = document.getElementById("nextPage");
        prevButton.parentElement.classList.toggle("disabled", currentPage === 1);
        nextButton.parentElement.classList.toggle("disabled", currentPage === totalPages || totalPages === 0);
        
        prevButton.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            if (currentPage % blockSize === 0 && currentBlockIndex > 0) currentBlockIndex--;
            renderTable(filteredData);
            updatePagination(filteredData.length);
          }
        });
        
        nextButton.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < totalPages) {
            currentPage++;
            if (currentPage % blockSize === 0 && currentPage < lastBlockStart) currentBlockIndex++;
            renderTable(filteredData);
            updatePagination(filteredData.length);
          }
        });
        
        paginationUl.querySelectorAll("a[data-page]").forEach(link => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const page = parseInt(e.target.getAttribute("data-page"));
            if (page !== currentPage) {
              if (page % blockSize === 0 && page < lastBlockStart) {
                currentBlockIndex = Math.floor(page / blockSize);
              } else if ((page - 1) % blockSize === 0 && currentBlockIndex > 0) {
                currentBlockIndex--;
              }
              currentPage = page;
              renderTable(filteredData);
              updatePagination(filteredData.length);
            }
          });
        });
      } else {
        pagination.style.display = "none";
      }
    }

    // Load data from API
    async function loadData(retries = 3) {
      const tbody = document.querySelector("#attendanceTable tbody");
      const paginationContainer = document.querySelector(".pagination-container");
      const paginationInfo = document.querySelector(".custom-pagination-info");
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-dark py-4">Data is loading. please wait...</td></tr>`;
      paginationContainer.style.display = "none";
      paginationInfo.style.display = "none";

      for (let i = 0; i < retries; i++) {
        try {
          // >>> CHANGED: fixed URL (removed trailing space)
          const response = await fetch('/attendance-summary');
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

          const json = await response.json();
          let data = Array.isArray(json) ? json : (json.data || json.records || json.results || []);
          if (!Array.isArray(data) || !data.length) throw new Error('No valid data received');

          // >>> CHANGED: Map from "First Entry"/"Last Exit" and compute HH:MM:SS
          allData = data.map(item => {
            const firstEntry = item["First Entry"] || item["first_entry"] || item.first_entry || item.FirstEntry || item["First Login"] || item.first_login || item.FirstLogin;
            const lastExit   = item["Last Exit"]   || item["last_exit"]   || item.last_exit   || item.LastExit   || item["Last Logout"] || item.last_logout || item.LastLogout;

            return {
              Name:        item.name || item.Name || 'N/A',
              EmployeeID:  item.employee_id || item.EmployeeID || 'N/A',
              Department:  item.department || item.Department || 'N/A',
              Location:    item.location || item.Location || 'N/A',
              FirstLogin:  firstEntry || 'N/A',   // show what API returns
              LastLogout:  lastExit   || 'N/A',   // show what API returns
              TotalIntime: calculateTotalIntime(firstEntry, lastExit) // HH:MM:SS
            };
          });

          filteredData = [...allData];
          renderTable(filteredData);
          populateDropdown("filterDepartment", [...new Set(allData.map(item => item.Department))]);
          populateDropdown("filterLocation", [...new Set(allData.map(item => item.Location))]);
          paginationContainer.style.display = filteredData.length > rowsPerPage ? "block" : "none";
          paginationInfo.style.display = "flex";
          return;
        } catch (err) {
          console.error(`Attempt ${i + 1} failed:`, err.message);
          if (i === retries - 1) {
            // Fallback demo rows remain fine; TotalIntime string may differ from new format — kept as-is
            allData = [
              { Name: "Durga", EmployeeID: "4105", Department: "Data Team", Location: "Tidel Park", "First Login": "2025-10-17 09:50:12", "Last Logout": "2025-10-17 13:47:28", TotalIntime: "03:57:16" },
              { Name: "Dhanu Priya", EmployeeID: "3129", Department: "Data Team", Location: "Tidel Park", "First Login": "2025-10-17 17:30:00", "Last Logout": "2025-10-18 09:15:00", TotalIntime: "15:45:00" },
              { Name: "Kavitha", EmployeeID: "2916", Department: "Data Team", Location: "Tidel Park", "First Login": "2025-10-17 08:45:00", "Last Logout": "2025-10-17 16:45:00", TotalIntime: "08:00:00" }
            ];
            // Normalize fallback fields for rendering
            allData = allData.map(r => ({
              Name: r.Name, EmployeeID: r.EmployeeID, Department: r.Department, Location: r.Location,
              FirstLogin: r["First Login"], LastLogout: r["Last Logout"], TotalIntime: r.TotalIntime
            }));
            filteredData = [...allData];
            renderTable(filteredData);
            populateDropdown("filterDepartment", [...new Set(allData.map(item => item.Department))]);
            populateDropdown("filterLocation", [...new Set(allData.map(item => item.Location))]);
            paginationContainer.style.display = filteredData.length > rowsPerPage ? "block" : "none";
            paginationInfo.style.display = "flex";
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-dark">No data available</td></tr>`;
          }
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    }

    // Filters – Same logic as attendance_logs.html
    document.getElementById("filterForm").addEventListener("submit", e => {
      e.preventDefault();
      const { filterId, filterDepartment, filterLocation, startDate, endDate } = document.getElementById("filterForm").elements;

      const idValue      = filterId.value.trim();
      const deptValue    = filterDepartment.value;
      const locValue     = filterLocation.value;
      const startValue   = startDate.value;
      const endValue     = endDate.value;

      let errorTitle = '';
      let errorMessage = '';

      const noFilters = !idValue && !deptValue && !locValue && !startValue && !endValue;

      if (noFilters) {
        errorTitle   = "No Filters Applied";
        errorMessage = "Please enter at least one filter to proceed.";
      } else if (startValue && endValue && new Date(startValue) > new Date(endValue)) {
        errorTitle   = "Invalid Date Range";
        errorMessage = "The 'From' date cannot be after the 'To' date.";
      }

      if (errorTitle) {
        document.getElementById('errorTitle').textContent   = errorTitle;
        document.getElementById('errorMessage').textContent = errorMessage;
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        modal.show();
        return;
      }

      filteredData = allData.filter(item => {
        const matchId   = !idValue || String(item.EmployeeID).toLowerCase().includes(idValue.toLowerCase());
        const matchDept = !deptValue || item.Department === deptValue;
        const matchLoc  = !locValue  || item.Location   === locValue;

        const matchDateRange = !startValue || !endValue || (
          (item.FirstLogin && new Date(item.FirstLogin.replace(' ', 'T')) >= new Date(startValue) && new Date(item.FirstLogin.replace(' ', 'T')) <= new Date(endValue + 'T23:59:59')) ||
          (item.LastLogout && new Date(item.LastLogout.replace(' ', 'T')) >= new Date(startValue) && new Date(item.LastLogout.replace(' ', 'T')) <= new Date(endValue + 'T23:59:59'))
        );

        return matchId && matchDept && matchLoc && matchDateRange;
      });

      currentPage = 1;
      currentBlockIndex = 0;
      renderTable(filteredData);
      document.querySelector(".pagination-container").style.display = filteredData.length > rowsPerPage ? "block" : "none";
      document.querySelector(".custom-pagination-info").style.display = "flex";
    });

    document.getElementById("clearFilters").addEventListener("click", () => {
      document.getElementById("filterForm").reset();
      filteredData = [...allData];
      currentPage = 1;
      currentBlockIndex = 0;
      renderTable(filteredData);
      document.querySelector(".pagination-container").style.display = filteredData.length > rowsPerPage ? "block" : "none";
      document.querySelector(".custom-pagination-info").style.display = "flex";
    });

    // Today Filter
    document.getElementById("todayFilter").addEventListener("click", () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("startDate").value = today;
      document.getElementById("endDate").value   = today;
      document.getElementById("filterForm").dispatchEvent(new Event("submit"));
    });

    // CSV Download
    document.getElementById("downloadCsv").addEventListener("click", () => {
      const dataToDownload = filteredData.length ? filteredData : allData;
      const headers = ["Name", "EmployeeID", "Department", "Location", "First Login", "Last Logout", "TotalIntime"];
      const rows = dataToDownload.map(item => [
        item.Name, item.EmployeeID, item.Department, item.Location,
        item.FirstLogin, item.LastLogout, item.TotalIntime
      ]);
      let csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(r => r.map(f => `"${f}"`).join(","))].join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "attendance_dashboard.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Excel Download
    document.getElementById("downloadExcel").addEventListener("click", () => {
      const dataToDownload = filteredData.length ? filteredData : allData;
      const ws = XLSX.utils.json_to_sheet(dataToDownload.map(item => ({
        Name: item.Name, EmployeeID: item.EmployeeID, Department: item.Department,
        Location: item.Location, "First Login": item.FirstLogin, "Last Logout": item.LastLogout,
        TotalIntime: item.TotalIntime
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance Dashboard");
      XLSX.writeFile(wb, "Attendance_Dashboard.xlsx");
    });

    // Rows per page
    document.getElementById('rowsPerPage').addEventListener('change', function (e) {
      rowsPerPage = parseInt(e.target.value);
      currentPage = 1;
      currentBlockIndex = 0;
      renderTable(filteredData);
      document.querySelector(".pagination-container").style.display = filteredData.length > rowsPerPage ? "block" : "none";
      document.querySelector(".custom-pagination-info").style.display = "flex";
    });

    // Initialize
    loadTopbar();
    loadData();
  </script>
</body>
</html>
